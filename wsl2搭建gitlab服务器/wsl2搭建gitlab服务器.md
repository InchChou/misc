# wsl2搭建gitlab服务器

## GitLab

GitLab** 是由 GitLab Inc.开发，一款基于Git的软件开发平台。另外，GitLab 且具有wiki以及在线编辑、issue跟踪功能、CI/CD 等功能。

## 选择wsl2作为平台

由于wsl不是使用的linux内核，有些linux命令还不支持，比如GitLab安装时需要的`upstart`、`initctl`。

GitHub上有相关[讨论](https://github.com/microsoft/WSL/issues/791#issuecomment-238027584)。

> WSL doesn't use Upstart to start processes at system boot. If you work closely with Upstart, this might cause some surprises for you; the message is informative to people who work directly with initctl, upstart, etc that WSL doesn't yet expose that functionality. 

所以需要真正的linux内核来驱动。此时有两个解决方案：1. 虚拟机；2. wsl2。

在我的电脑上有wsl2，发行版为ubuntu-20.04(Focal Fossa)；以及wsl，发行版为ubuntu-18.04(Bionic Beaver)。只有wsl2能够安装GitLab。

## 使用docker安装 VS 直接安装

由于还未使用docker进行试验，所以先介绍直接安装。

### 直接安装

#### 官网步骤

可以直接按照官网上的命令进行安装：https://about.gitlab.com/install/?version=ce#ubuntu

GitLab的依赖有：`curl openssh-server ca-certificates tzdata`，还有`postfix`用来自动发送邮件。

但是我的`curl`在执行

```bash
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
```

会报错`curl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number`。这个错一直没有解决，所以另寻他法。

从官网的脚本可以看出，它实际上是先设置了ubuntu的apt源，将`/etc/apt/sources.list.d/gitlab_gitlab-ce.list`设置为

```bash
# this file was generated by packages.gitlab.com for
# the repository at https://packages.gitlab.com/gitlab/gitlab-ee

deb https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ bionic main
deb-src https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ bionic main
```

然后再执行

```bash
sudo EXTERNAL_URL="https://gitlab.example.com" apt-get install gitlab-ce
```

安装GitLab。

所以可以直接设置[清华大学的镜像源](https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/)，然后再执行`apt-get install gitlab-ce`进行安装。

#### 下载.deb文件安装

##### 1. 下载deb文件

由于公司的网连不上清华大学的镜像源。所以手动将GitLab的deb包下载下来进行安装，可以在

https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/bionic/main/g/gitlab-ce/和

https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/focal/main/g/gitlab-ce/下载deb包。其中bionic和focal分别对应ubuntu18.04和20.04版本的第一个单词。

##### 2. 安装deb

下载完后，执行

```bash
sudo dpkg -i gitlab-ce_13.4.4-ce.0_amd64.deb
```

进行安装。

##### 3. 设置gitlab.rb

```bash
sudo vim /etc/gitlab/gitlab.rb
```

将`EXTERNAL_URL`的值改成[http://宿主机ip:端口号](http://宿主机ip:端口号)。**（存疑）**

我这里改成了[http://宿主机ip:8888](http://宿主机ip:8888)。

> PS: 由于在后面做了端口转发，所以也可以将地址改成[http://localhost:8888](http://localhostip:8888)。（后面验证过不行）
>
> 在使用中发现，`EXTERNAL_URL`是指暴露出去的URL，会影响git push的时候创建merge request的生成，命令行中返回的网址为
>
> `<EXTERNAL_URL>/<user>/<repo>/-/merge_requests/new?merge_request%5Bsource_branch%5D=<branch>`
>
> 如下所示
>
> ```shell
> remote: To create a merge request for dev, visit:
> remote:   http://localhost:8888/user/repo/-/merge_requests/new?merge_request%5Bsource_branch%5D=dev
> ```
>
> 所以应该设置`EXTERNAL_URL`为外部计算机能访问的网址，即此时的宿主机地址。

运行以下命令重新配置GitLab

```bash
sudo gitlab-ctl reconfigure
```

在执行`reconfigure`命令的时候我的wsl2会在下面命令时卡住

```
ruby_block[wait for redis service socket] action run
```

此时有解决方案如下：

再另外开启一个终端，启动如下下命令：

```bash
sudo /opt/gitlab/embedded/bin/runsvdir-start
```

或者在当前的终端窗口中后台执行上述命令

```bash
nohup /opt/gitlab/embedded/bin/runsvdir-start &
```

此时当前终端窗口的命令会继续执行下去，如果状态是被中断了，则再次执行`sudo gitlab-ctl reconfigure`即可。

> ```
> ---在powershell中重启WSL
> net restart LxssManager
> 或
> Get-Service LxssManager | Restart-Service
> ```

##### 4. 重新运行GitLab

```bash
sudo gitlab-ctl restart
```

##### 5. Window 与 Linux 网络打通（还未完全弄懂）

由于GitLab是在wsl2中，只有本机能通过（http://宿主机ip:8888）访问gitlab，局域网的其他电脑不能访问到此地址，所以需要使用Windows自带的端口转发工具`netsh interface portproxy`。

该命令的语法如下：

```powershell
netsh interface portproxy add v4tov4 listenaddress=localaddress listenport=localport connectaddress=destaddress connectport=destport
```

`listenaddress` –是等待连接的本地IP地址。
`listenport` –本地侦听TCP端口（正在等待连接）。
`connectaddress` –是将传入连接重定向到的本地或远程IP地址（或DNS名称）。
`connectport` –是一个TCP端口，来自侦听端口的连接被转发到该TCP端口。

使用管理员权限打开powershell，输入

```powershell
netsh interface portproxy add v4tov4 listenport=监听端口 connectaddress=转发到的地址 connectport=转发到的端口
```

或

```powershell
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=监听端口 connectaddress=转发到的地址 connectport=转发到的端口
```

> listenaddress=0.0.0.0的作用还未知，推测就是将所有外部ip都监听。

此时”监听端口“设置为与”转发到的端口“一致，同为8888，地址为wsl2的ip地址，可以在wsl2中使用`ifconfig`获取，上面的命令表示把所有外部ip连接本地8888端口的请求重定向到转发地址的8888端口上。

设置完后，使用[http://windows本机ip:8888](http://windows本机ip:8888)即可访问GitLab网页。

但是此时只有http协议能访问，git常用的ssh不能访问，所以还需要下一步。

##### 6. 打开wsl2的ssh server功能

为了能让GitLab的ssh功能正常使用，还需要开启wsl2的ssh server功能。

首先可以使用`ps -e | grep ssh`来查看ssh服务有没有开启，如果返回的结果中有`xxxx sshd`，说明ssh的守护进程已经开启。

如果没有反应或者其他结果，再试着开启SSH服务。使用命令sudo /etc/init.d/ssh start来开启服务：

```bash
$ sudo /etc/init.d/ssh start
 * Starting OpenBSD Secure Shell server sshd
 sshd: no hostkeys available -- exiting.
```

说明名义安装ssh服务。使用命令`sudo apt-get install openssh-server`来安装即可。

由于ssh服务所使用的端口是22，所以需要将windows的22端口转发到wsl的22端口：

```powershell
netsh interface portproxy add v4tov4 listenport=22 connectaddress=转发到的地址 connectport=22
```

此时使用`netsh interface portproxy show all`来查看转发规则应该有两条：

```powershell
> netsh interface portproxy show all

侦听 ipv4:                 连接到 ipv4:

地址            端口        地址            端口
--------------- ----------  --------------- ----------
*               8888        转发到的地址     8888
*               22          转发到的地址     22
```

设置完毕即可。”转发到的地址“即wsl2的地址

> 由于每次windows开机时都会随机给wsl2一个地址，转发规则也会失效，所以可以写一个powershell脚本来随开机启动，并设置转发规则。

##### 7. 首次登录

在Web浏览器中访问GitLab服务器的域名：

[http://windows本机ip:8888](http://windows本机ip:8888)

在首次访问时，会看到为管理账户设置密码的初始提示，修改一下即可。

##### 8. 卸载GitLab

1. 查看gitlab是否运行：
   ```bash
   sudo gitlab-ctl stop
    
   ps -ef | grep gitlab
    
   kill -9 xxx
   ```

2. 卸载gitlab

   ```bash
   sudo gitlab-ctl uninstall
   # 需要区分ce版和ee版
   sudo dpkg -r gitlab-ce
   ```

3. 删除所有包含gitlab的文件

   ```bash
   sudo find / -name gitlab | xargs rm -rf
   ```

### 使用docker安装（还未试验）

#### 1. 安装docker

``` bash
# 准备
sudo apt remove docker docker-engine docker.io

sudo apt install apt-transport-https ca-certificates curl software-properties-common gnupg

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo apt-key fingerprint 0EBFCD88

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

sudo apt update

# 安装
sudo apt install docker-ce

# 启动
sudo service docker start
```

#### 2. 安装GitLab

```bash
# 拉取镜像
sudo docker pull gitlab/gitlab-ce:latest

# 启动，注意：localhost 换成宿主机 ip，user 换成自己用户名
sudo docker run --detach --hostname localhost --publish 443:443 --publish 80:80 --publish 22:22 --name gitlab --volume /home/user/gitlab/config:/etc/gitlab --volume /home/user/gitlab/logs:/var/log/gitlab --volume /home/user/gitlab/data:/var/opt/gitlab -m 3g  gitlab/gitlab-ce:latest 

```

#### 3. Window 与 Linux 网络打通

以**管理员身份**打开 PowerShell

```powershell
# ip 为 Linux ip，请替换
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=ip
```

#### 4. 访问GitLab

最后，您可以在 Windows ，通过 [http://ip](http://ip)，访问 gitlab



